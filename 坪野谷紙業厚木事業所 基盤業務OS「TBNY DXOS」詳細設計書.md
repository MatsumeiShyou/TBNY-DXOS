# **坪野谷紙業厚木事業所 基盤業務OS「TBNY DXOS」詳細設計書**

## **1\. プロジェクト総論：業務OSとしてのDX定義**

本プロジェクトが目指すデジタルトランスフォーメーション（DX）の本質は、単なる個別業務のアプリケーション化ではない。それは、全業務の基底層として機能し、事業継続性を構造的に担保する\*\*「業務OS（Operating System）」\*\*の構築である。

現状、坪野谷紙業の業務知見は特定の「個人」に強く依存しており、特に起床後から出社前のわずか30〜40分間に集中する「配車計画」フェーズは、極めて高い認知負荷と判断ミスによる事業崩壊リスクを孕んでいる。本OSの真の目的は、この\*\*「事業リスクの震源地（エピセンター）」を保護**し、**「業務知識を『人』から『構造（OS）』へ移転する」\*\*ことにある。これにより、属人的な「勘」に頼る運用を脱却し、誰が担当しても整合性が保たれる「構造的信頼」を構築する。

### **OSの3層構造定義**

本OSは、変化への耐性とミッションクリティカルな整合性を両立させるため、以下の3層に分離して設計される。

* **データ中枢（不変層 / Immutable Layer）**  
  * **役割：** 人、リソース、日付、そして客観的事実としての「State（状態）」を管理。  
  * **特性：** 高い整合性を要求し、直接のUPDATE/DELETEを物理的に禁止する不変データ層。  
* **業務フロー（半固定層 / Semi-Fixed Layer）**  
  * **役割：** 承認プロセス、二段階確定モデル、バリデーション等の「業務の作法」を管理。  
  * **特性：** 法令や社内憲法に基づき、ガバナンスを維持しつつ、改善に応じて段階的に進化する。  
* **アプリケーションUI（可変層 / Malleable Layer）**  
  * **役割：** 現場、事務、管理者が操作する具体的なインターフェース。  
  * **特性：** デバイスの進化や現場のフィードバックに基づき、最も高速に改善・交換される。

### **「業務事故の構造的排除」のメカニズム**

従来のシステム（CRUDモデル）は、UPDATE文によって過去の事実（当初の計画等）を無慈悲に上書きし、「組織の記憶」を破壊してきた。本OSでは、すべての変更を「State（状態）に対するDecision（判断）」として記録する。 事故は曖昧な判断から生まれる。本設計では「なぜその数値になったのか」という\*\*判断の文脈（Reason）\*\*をデータ構造そのものに組み込むことで、改ざん不能な監査証跡を構築し、事故の芽を構造的に摘み取る。

次セクションで定義する「DX設計憲法」は、このOSを支え、いかなる技術的誘惑にも屈しないための「法的根拠」である。

\--------------------------------------------------------------------------------

## **2\. DX設計憲法：システム設計の最上位原則**

「DX設計憲法 Ver.3.0」は、開発に関わるすべての人間とAIが遵守すべき絶対的ルールである。技術的な最適化や効率性よりも、本憲法に基づく「安全性」と「説明可能性」が優先される。この戦略的トレードオフは、現場の混沌に耐えうる「不壊のシステム」を構築するための唯一の手段である。

### **4大原則の詳述**

以下の原則は、いかなる状況下でも優先されなければならない。

| 原則 | 定義 | 違反と見なされる具体例（禁止事項） |
| :---- | :---- | :---- |
| **1\. 人間の最終判断権** | システムは「提案」を行い、最終的な「確定（Decision）」は必ず人間が行う。 | AIの予測に基づき、配車計画を自動で「確定」状態で更新すること。 |
| **2\. 状態と履歴の不可逆性** | 事実は改ざんせず、すべての変更はAppend-only（追記型）で記録されなければならない。 | 誤入力を修正するために既存レコードを`UPDATE`し、変更前の値を消去すること。 |
| **3\. 現場例外の許容と記録** | 理想フローを提示しつつ、緊急時の例外操作（強制操作）を認め、その理由を詳細に記録する。 | バリデーションエラーにより、現場の緊急スワップ操作が物理的に不能になること。 |
| **4\. 安全性と可読性の優先** | 内部ロジックを透明化し、ブラックボックスを排除する。可読性は最適化に勝る。 | 複雑な正規化や難解なクエリ、または根拠不明なAIによる自動推薦。 |

### **「判断」と「実行」の分離**

本OSにおける意思決定プロセスは、以下のフローを厳守する。

1. **AI/Systemによる提案（Proposal）：** マスターと過去実績に基づき、下書き（Draft）を提示する。  
2. **人間による確定（Decision）：** 提示された提案を人間がレビューし、「実行ボタン」を押下して責任を引き受ける。 この境界線を明確にすることで、責任の所在をブラックボックスから人間に取り戻す。この原則をデータレベルで具現化するのが、次章の「SDRモデル」である。

\--------------------------------------------------------------------------------

## **3\. コア・データアーキテクチャ：SDR（State / Decision / Reason）モデル**

SDRモデルは、組織の記憶を資産化するためのデータ構造であり、従来のCRUDモデルに対する宣戦布告である。UPDATE文による「事実の抹消」を拒絶し、意思決定の履歴すべてを「正史」として保存する。

### **SDR要素の厳密定義**

各エンティティは以下の要素を三位一体で保持しなければならない。

* **State（状態）：** 特定時点の事実のスナップショット。  
* **Decision（判断）：** 状態を遷移させた意思。以下のフィールドを必須とする。  
  * `Actor` (誰が), `Timestamp` (いつ), `DecisionCode` (操作種別), `is_admin_forced` (強制操作フラグ)  
  * **Snapshots:** `data_before` および `data_after` の完全なJSONスナップショット。  
* **Reason（理由）：** 判断の正当性。  
  * `ReasonCode` (理由の分類), `Note` (補足テキスト)

### **不変条件（Invariants）の形式化**

AI実装時、以下の公理をバリデーションロジックとして組み込め。

* \[ \] **公理1:** StateはDecisionの結果としてのみ変化する（直接的なState変更の禁止）。  
* \[ \] **公理2:** Decisionは必ずReason（ReasonCode）を伴わなければならない。  
* \[ \] **公理3:** `UPDATE` および `DELETE` コマンドの発行を原則禁止し、`event_logs` への `INSERT` のみで状態遷移を表現する。  
* \[ \] **公理4:** State / Decision / Reason の各要素は、`event_logs` 等のテーブルで論理的・物理的に分離されていること。

### **アンチパターンの排除**

「statusカラムをenumで管理し、値を書き換えるだけ」の設計は、SDRモデルにおける最大の「反逆罪」である。これは過去の計画という事実を破壊し、事故調査を不可能にする。例外的な事態こそ、`is_admin_forced=true` を伴うDecisionとして誇りを持って記録されなければならない。

\--------------------------------------------------------------------------------

## **4\. 物理システム構成とインフラストラクチャ**

「Hot/Log/Media 分離保管」の思想に基づき、技術スタックを役割ごとに最適化する。これは「特定の技術への依存」を避け、データの永続性を最大化するための構成である。

### **データ配置戦略とマスタ分離**

特筆すべきは、請求と物流を分離する\*\*「マスターデータの三層分離」\*\*である。

| 区分 | 利用サービス | データ種別 | 選定理由・制約 |
| :---- | :---- | :---- | :---- |
| **Hotデータ** | **Supabase (PostgreSQL)** | リアルタイム業務データ、SDRログ、認証 | RDBの整合性と高速なAPI応答。 |
| **Logデータ** | **Google Sheets** | 事務用監査ログ、長期保管バックアップ | 非開発者が直接閲覧・検索可能であること。 |
| **Mediaデータ** | **Cloudflare R2** | 計量証憑写真、署名データ | 安価、堅牢、かつ高速な配信。 |

**重要：マスターデータの三層分離（Master Data Triad）** 請求の複雑性が配車ロジックを汚染することを防ぐため、以下の3つを物理的に分離して管理する。

1. **支払先（Payer）：** 請求・支払の主体。  
2. **仕入先（Supplier）：** 契約の主体。  
3. **回収先（Location）：** 物流の現場（物理的な地点）。

### **認証・権限管理（Core基盤）**

Staffごとのアプリアクセス権限はJSON形式で管理され、UIは動的にこれを解釈する。

{ "staffId": "A001", "allowedApps": \["app\_logistics", "app\_weighing"\] }

UIはこの `allowedApps` に含まれないモジュールのルートへのアクセスを物理的に遮断（Deny by Default）し、画面描画を省略しなければならない。

\--------------------------------------------------------------------------------

## **5\. 中核アプリケーション設計：Repaper Route（動的配車管理）**

事業リスクの震源地である配車計画を「安全装置」で保護するためのリファレンス実装。

### **動的配車ガントチャートのUI仕様**

* **グリッド：** 1時間あたり128px、最小単位15分（32px）の精密設計。  
* **Smart Coloring：** 18色のパレットを使用し、隣接するコース・案件間で視覚的衝突が発生しないよう自動配色。  
* **Z-Index階層：**  
  * `Z-Index 40`: 現在時刻線、選択中のドラッグカード（最前面）  
  * `Z-Index 20`: 通常の案件カード  
  * `Z-Index 0`: 背景グリッド

### **「二段階確定モデル」のロジック**

1. **一次確定 (Primary Confirmation):** 業務開始前に配車計画を「Confirmed」状態にし、通常編集をロック。これを「正史」とする。  
2. **例外イベント処理:** 確定後の変更（トラブル、欠勤等）は、既存レコードの書き換えではなく、`event_logs` への「変更イベント」として追記。  
3. **表示合成:** UIは「Confirmed State（正史）」＋「Log Overlay（例外イベント）」をリアルタイムでマージして描画する。

### **制約レイヤー（ガードレール）の定義**

* **ブロック（赤枠）：** 法的・物理的不可（例：免許不保持、帰社まで変更不可の車両固定区間）。  
* **警告（黄枠）：** 業務リスクあり。実行には **Reason（理由コード）の入力が必須**。  
* **ヒント：** 効率化のアドバイス。

\--------------------------------------------------------------------------------

## **6\. 統合モジュール設計：セルフ計量記録システム**

現場の過酷な環境（オフライン・屋外）に対応しつつ、データの整合性を死守するモジュール。

### **PWAとオフライン戦略**

* **Service Worker / IndexedDB:** 圏外でもアプリを起動し、入力を継続。オンライン復帰時にSDRモデルに準拠した形式で自動同期を試みる。

### **重量整合性検証とミッションクリティカル制約**

本システムの計量値には、物理的な精度に基づく**絶対的なバリデーションルール**を適用する。

1. **10kg制約の徹底：**  
   * 台貫および品目重量の入力は、**すべて10kg単位**で行われなければならない。  
   * **入力値の1の位が「0」でない場合、UIは送信をブロックし、警告を表示する。**（例: 505kgは不可、500kgまたは510kgのみ許容）  
2. **監査ロジック：**  
   * `総重量 - 空車重量 = 品目合計重量` の不一致を常時監視。  
   * 誤差発生時は「強制送信」フラグとReasonの入力を求め、監査ログへ異常値として記録する。

\--------------------------------------------------------------------------------

## **7\. UI/UX標準とAI協調開発への指針**

### **AI Proposals（提案）の提示作法**

AIによる提案は、既存のStateを直接書き換えることを厳格に禁じる。

* **Proposal Layer:** AIの計算結果は「提案レイヤー」として別枠で表示される。  
* **Human Decision:** 人間が提案を「採用」した瞬間に、`Actor=Human` としてのDecisionログが生成され、Stateが更新される。AIは提案者であり、決定者ではない。

### **共通UIコンポーネントの挙動**

* **シングルクリック:** 文脈（Context）の参照。  
* **右クリック/長押し:** 操作候補（Decision Trigger）の提示。  
* **ドラッグ＆ドロップ:** 計画の調整。エメラルド枠（可）、赤枠（不可）のプレビューを必須とする。

\--------------------------------------------------------------------------------

## **8\. 将来構想とバックログ：進化するOS**

### **拡張機能の憲法適合性**

* **AI遅延予測:** 過去のSDRデータを学習し、Proposal Layerに予測を表示する。  
* **自動展開ロジック:** 出勤管理データから配車の下書きを自動生成。  
* **OCR重量読み取り:** 計量器の写真を解析し、10kg単位に丸めた数値を提案する。 これらはいずれも「人間の最終判断権」を侵害しない範囲で実装される。

### **開発者（AI Agent）への最終指令**

本設計書を読み解き、コードを生成するすべてのAIへ命じる。 貴殿が生成するコードにおいて、**State（事実）、Decision（判断）、Reason（理由）の三位一体を損なう記述は、一切の例外なく「バグ」と見なす。** `UPDATE`文に逃げるな。過去を殺すな。 我々が作るのは、利便性のための道具ではない。坪野谷紙業の未来の判断を支える「信頼の記録装置」である。 **State/Decision/Reasonの不変条件をコンパイルレベルで死守せよ。**

