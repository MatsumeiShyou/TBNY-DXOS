# 坪野谷紙業厚木事業所 基盤業務OS「TBNY DXOS」

## 📋 プロジェクト概要

**TBNY DXOS（Tsubonoya Business Operating System）**は、坪野谷紙業厚木事業所のための包括的な業務管理プラットフォームです。本プロジェクトは単なる業務アプリケーションの集合体ではなく、事業継続性を構造的に担保する「業務OS（Operating System）」として設計されています。

### 🎯 プロジェクトの目的

従来、坪野谷紙業の業務知見は特定の個人に強く依存しており、特に**配車計画フェーズ**（起床後から出社前のわずか30〜40分間）は、極めて高い認知負荷と判断ミスによる事業崩壊リスクを孕んでいました。

本OSの真の目的は:
- **事業リスクの震源地（エピセンター）の保護**: 配車計画などのミッションクリティカルな業務を安全装置で保護
- **業務知識の「人」から「構造（OS）」への移転**: 属人的な「勘」に頼る運用を脱却
- **構造的信頼の構築**: 誰が担当しても整合性が保たれる仕組みの実現

## 🏗️ アーキテクチャ哲学

### OSの3層構造

本OSは、変化への耐性とミッションクリティカルな整合性を両立させるため、以下の3層に分離して設計されています。

| 層 | 役割 | 特性 |
|---|---|---|
| **データ中枢（不変層）** | State（状態）の管理 | 直接のUPDATE/DELETE禁止の不変データ層 |
| **業務フロー（半固定層）** | 承認プロセス、バリデーション | 法令・社内憲法に基づくガバナンス |
| **アプリケーションUI（可変層）** | ユーザーインターフェース | 最も高速に改善・交換される層 |

### SDR（State / Decision / Reason）モデル

従来のCRUDモデルに対する宣戦布告として、**SDRモデル**を採用しています。UPDATE文による「事実の抹消」を拒絶し、意思決定の履歴すべてを「正史」として保存します。

- **State（状態）**: 特定時点の事実のスナップショット
- **Decision（判断）**: 状態を遷移させた意思（Actor、Timestamp、DecisionCode、強制操作フラグ等）
- **Reason（理由）**: 判断の正当性（ReasonCode、補足テキスト）

> [!IMPORTANT]
> 「statusカラムをenumで管理し、値を書き換えるだけ」の設計は、SDRモデルにおける最大の「反逆罪」です。過去の計画という事実を破壊し、事故調査を不可能にします。

## 🛠️ 技術スタック

### フロントエンド
- **フレームワーク**: Vite + React 19.2 + TypeScript
- **ビルドツール**: Vite 7.3
- **リンター**: ESLint 9.x
- **スタイル**: CSS（デザイントークンシステム）

### バックエンド・インフラ
- **ホットデータ**: Supabase (PostgreSQL) - リアルタイム業務データ、SDRログ、認証
- **ログデータ**: Google Sheets - 事務用監査ログ、長期保管バックアップ
- **メディアデータ**: Cloudflare R2 - 計量証憑写真、署名データ

### データベース設計
- **マスターデータの三層分離**: 
  - `payers`（支払先：請求・支払の主体）
  - `suppliers`（仕入先：契約の主体）
  - `locations`（回収先：物理的な地点）
- **イベントログ**: `event_logs`（すべての意思決定の記録）
- **リソース管理**: `staffs`（スタッフ）、`vehicles`（車両）、`routes`（ルート）

## 📁 プロジェクト構造

```
tbny-dxos/
├── .agent/                          # AI開発エージェント関連
│   └── scripts/
│       └── check_seal.js            # ガバナンス検証スクリプト
├── src/                             # フロントエンドソースコード
│   ├── App.tsx                      # メインアプリケーション
│   ├── main.tsx                     # エントリーポイント
│   ├── index.css                    # グローバルスタイル
│   ├── styles/                      # スタイルシート
│   └── assets/                      # 静的アセット
├── supabase/                        # Supabase設定
│   └── migrations/
│       └── 20260210_initial_schema.sql  # 初期スキーマ（SDRモデル）
├── public/                          # 公開静的ファイル
├── AGENTS.md                        # AI開発エージェント憲法（v2.2）
├── AMPLOG.md                        # 資産変更申請記録
├── DEBT_AND_FUTURE.md               # 技術的負債・将来構想
├── SCHEMA_HISTORY.md                # スキーマ変更履歴
├── SDR（...）モデル原理定義書.md    # SDRモデル詳細仕様
├── 坪野谷紙業厚木事業所 DX設計憲法 Ver.3.0.md  # 設計憲法
├── 坪野谷紙業厚木事業所 基盤業務OS「TBNY DXOS」詳細設計書.md  # 詳細設計書
├── 業務OSの中核：Repaper Route .md  # Repaper Route設計構想
├── 統合予定モジュールアプリ１.md    # 統合モジュール設計
├── package.json                     # 依存関係定義
├── vite.config.ts                   # Vite設定
├── tsconfig.json                    # TypeScript設定
└── README.md                        # 本ドキュメント
```

## 🚀 セットアップと実行

### 前提条件
- Node.js (推奨: v18以降)
- npm または yarn
- Supabaseアカウント（データベース用）

### インストール

```bash
# 依存関係のインストール
npm install
```

### 開発サーバーの起動

```bash
# 開発サーバーを起動（ホットリロード有効）
npm run dev
```

開発サーバーが起動したら、ブラウザで `http://localhost:5173` にアクセスしてください。

### ビルド

```bash
# TypeScriptのコンパイル + 本番ビルド
npm run build
```

### リント

```bash
# ESLintによるコード検証
npm run lint
```

### プレビュー

```bash
# ビルド済みアプリのプレビュー
npm run preview
```

## ✨ 現在の実装状況

### TBNY DXOS（業務OSプラットフォーム）- 実装済み
- ✅ **基本プロジェクト構造**: Vite + React + TypeScript環境
- ✅ **SDRデータベーススキーマ**: 不変イベントログシステム
- ✅ **マスターデータ管理**: Payers、Suppliers、Locations、Vehicles、Routes
- ✅ **ガバナンスプロトコル**: AI開発エージェント憲法（AGENTS.md）
- ✅ **承認フロー管理**: AMPLOG（資産変更申請記録）
- ✅ **スキーマ履歴管理**: SCHEMA_HISTORY.md
- ✅ **Row Level Security (RLS)**: データベースレベルのセキュリティ

## 📱 TBNY DXOS上で動作するアプリケーション

TBNY DXOSは業務OSプラットフォームであり、その上で複数の業務アプリケーションが動作します。以下はTBNY DXOS上で開発予定または開発中のアプリケーション（追加アプリ）です。

### 🔄 中核アプリケーション: Repaper Route（動的配車管理）
**TBNY DXOS上で動作する中核的な追加アプリケーション**

事業リスクの震源地である配車計画を保護するための業務アプリ。TBNY DXOSのSDRモデルとガバナンスプロトコルを活用した、リファレンス実装でもあります。

**主要機能**:
- 動的配車ガントチャート（時間軸：06:00〜18:00、最小単位15分）
- Smart Coloring（18色パレット、隣接衝突回避）
- 制約レイヤー（ガードレール）:
  - レベル1: 法的・物理的制約（赤枠でブロック）
  - レベル2: 業務制約（黄枠で警告 + 理由入力必須）
  - レベル3: 最適化条件（ヒント表示）
- 二段階確定モデル:
  - 一次確定（Primary Confirmation）: 計画のロック
  - 例外イベント処理: 変更を履歴として追記

**開発状況**: 設計完了、実装待ち

### 📦 セルフ計量記録システム（計量管理アプリ）
**TBNY DXOS上で動作する現場向けアプリケーション**

現場の過酷な環境（オフライン・屋外）に対応しつつ、TBNY DXOSのデータ整合性要件を死守するアプリ。

**主要機能**:
- PWAによるオフライン対応（Service Worker + IndexedDB）
- 重量整合性検証（10kg単位制約の徹底）
- 監査ロジック（総重量 - 空車重量 = 品目合計重量）
- 計量証憑写真管理（Cloudflare R2統合）

**開発状況**: 設計完了、実装待ち

## 🔐 プラットフォーム機能（開発中）

### 認証・権限管理
TBNY DXOSプラットフォームのコア機能として、すべてのアプリケーションが利用する統一認証・権限管理システム。

- スタッフごとのアプリアクセス権限（JSONによる動的管理）
- Deny by Default原則
- UIレベルでのアクセス制御

**開発状況**: スキーマ準備済み、実装待ち

## 📚 ガバナンス・憲法

本プロジェクトは厳格なガバナンスプロトコルに従って開発されています。

### DX設計憲法 4大原則

1. **人間の最終判断権**: システムは「提案」を行い、最終的な「確定（Decision）」は必ず人間が行う
2. **状態と履歴の不可逆性**: すべての変更はAppend-only（追記型）で記録
3. **現場例外の許容と記録**: 緊急時の例外操作を認め、その理由を詳細に記録
4. **安全性と可読性の優先**: 内部ロジックを透明化し、ブラックボックスを排除

### AI開発エージェント憲法（AGENTS.md）

AI開発エージェントが従うべき絶対的ルール:
- **Mandatory Evidence Protocol (MEP)**: すべての回答で適用ルールの宣言義務
- **AMPLOG Protocol**: 実装前に`check_seal.js`で検証（Exit Code 0必須）
- **Strict Seal Protocol**: 承認は "ｙ" の完全一致のみ
- **Core 4 Principles**: No Leakage、Honesty、Retreat、No Guessing

詳細は [`AGENTS.md`](./AGENTS.md) を参照してください。

## 🐛 課題・技術的負債

現在の技術的負債と課題は [`DEBT_AND_FUTURE.md`](./DEBT_AND_FUTURE.md) で管理されています。

### 主な課題
- [ ] Repaper Route UIの実装
- [ ] セルフ計量記録システムの実装
- [ ] Supabase認証の統合
- [ ] デザインシステムの完成

## 🔮 将来構想・アイディア

### 拡張機能（憲法適合性確認済み）
- **AI遅延予測**: 過去のSDRデータを学習し、Proposal Layerに予測を表示
- **自動展開ロジック**: 出勤管理データから配車の下書きを自動生成
- **OCR重量読み取り**: 計量器の写真を解析し、10kg単位に丸めた数値を提案

> [!NOTE]
> これらの機能は「人間の最終判断権」を侵害しない範囲で実装されます。

## 🤝 貢献方法

### バグ報告
バグを発見した場合は、以下の情報を含めて報告してください:
1. 発生した問題の詳細
2. 再現手順
3. 期待される動作
4. 実際の動作
5. 環境情報（ブラウザ、OS等）

### 改善提案
機能追加や改善提案は以下の観点で検討されます:
1. **DX設計憲法との適合性**: 4大原則に違反していないか
2. **SDRモデルの遵守**: State/Decision/Reasonの三位一体を損なわないか
3. **影響範囲**: 既存の業務フローへの影響
4. **実装コスト**: 開発・保守コスト

### 開発プロセス
1. **提案（Proposal）**: 変更内容の提案
2. **承認（Seal）**: "ｙ" による承認
3. **記録（AMPLOG）**: `AMPLOG.md` への記録
4. **実装（Action）**: コード変更の実施

詳細は [`AMPLOG.md`](./AMPLOG.md) を参照してください。

## 📖 関連ドキュメント

- [AGENTS.md](./AGENTS.md) - AI開発エージェント憲法
- [AMPLOG.md](./AMPLOG.md) - 資産変更申請記録
- [SCHEMA_HISTORY.md](./SCHEMA_HISTORY.md) - スキーマ変更履歴
- [DEBT_AND_FUTURE.md](./DEBT_AND_FUTURE.md) - 技術的負債・将来構想
- [坪野谷紙業厚木事業所 DX設計憲法 Ver.3.0.md](./坪野谷紙業厚木事業所%20DX設計憲法%20Ver.3.0.md) - 設計憲法
- [坪野谷紙業厚木事業所 基盤業務OS「TBNY DXOS」詳細設計書.md](./坪野谷紙業厚木事業所%20基盤業務OS「TBNY%20DXOS」詳細設計書.md) - 詳細設計書
- [業務OSの中核：Repaper Route .md](./業務OSの中核：Repaper%20Route%20.md) - Repaper Route設計構想
- [SDR（State _ Decision _ Reason）モデル原理定義書.md](./SDR（State%20_%20Decision%20_%20Reason）モデル原理定義書.md) - SDRモデル詳細仕様

## 📜 ライセンス

本プロジェクトは坪野谷紙業厚木事業所の内部プロジェクトです。

## 📞 コンタクト

プロジェクト管理者: 坪野谷紙業厚木事業所 開発チーム

---

**State/Decision/Reasonの不変条件をコンパイルレベルで死守せよ。**

*我々が作るのは、利便性のための道具ではない。坪野谷紙業の未来の判断を支える「信頼の記録装置」である。*
